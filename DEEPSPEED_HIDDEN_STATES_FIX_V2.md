# DeepSpeedå…¼å®¹çš„hidden_states NCCLè¶…æ—¶ä¿®å¤ V3 (ç»ˆæç‰ˆ)

## ğŸš¨ é—®é¢˜æ ¹æº

ç”¨æˆ·åé¦ˆåœ¨**ç¬¬ä¸€æ¬¡è¯„ä¼°åä»ç„¶å‡ºç°NCCLè¶…æ—¶**ï¼Œé”™è¯¯ä¿¡æ¯ä¾ç„¶æ˜¾ç¤ºï¼š

```
WorkNCCL(SeqNum=2131, OpType=ALLREDUCE, NumelIn=467019003, NumelOut=467019003, Timeout(ms)=600000)
```

è¿™è¯´æ˜æˆ‘ä»¬çš„V1ä¿®å¤**æ²¡æœ‰ç”Ÿæ•ˆ**ï¼

## ğŸ” V1ä¿®å¤å¤±æ•ˆçš„åŸå› 

### åŸå› 1ï¼šDeepSpeedæ¨¡å‹åŒ…è£…é—®é¢˜

å½“ä½¿ç”¨DeepSpeedæ—¶ï¼Œæ¨¡å‹è¢«åŒ…è£…ï¼š

```python
self.model, self.optimizer, _, self.lr_scheduler = deepspeed.initialize(
    model=model,  # åŸå§‹æ¨¡å‹
    optimizer=optimizer,
    lr_scheduler=lr_scheduler,
    config=self.config['deepspeed']
)
# ç°åœ¨ self.model æ˜¯ DeepSpeed åŒ…è£…åçš„æ¨¡å‹
```

**é—®é¢˜**ï¼šDeepSpeedåŒ…è£…åï¼Œ`model.training`çŠ¶æ€å¯èƒ½ä¸å†…éƒ¨æ¨¡å‹`model.module.training`çŠ¶æ€ä¸ä¸€è‡´ï¼

### åŸå› 2ï¼šè¯„ä¼°æ¨¡å¼è®¾ç½®ä¸å½»åº•

è¯„ä¼°å‡½æ•°åªè°ƒç”¨äº†`model.eval()`ï¼Œä½†å¯¹äºDeepSpeedåŒ…è£…çš„æ¨¡å‹ï¼Œè¿˜éœ€è¦ï¼š

```python
model.eval()           # è®¾ç½®åŒ…è£…å™¨
model.module.eval()    # è®¾ç½®å†…éƒ¨å®é™…æ¨¡å‹
```

## ğŸ’¡ **é‡å¤§å‘ç°ï¼šè®­ç»ƒæ—¶ä¹Ÿä¸éœ€è¦hidden_statesï¼**

é€šè¿‡æ·±å…¥ä»£ç åˆ†æå‘ç°ï¼š

### ğŸ” **è®­ç»ƒå’Œè¯„ä¼°è¿‡ç¨‹çš„å®é™…éœ€æ±‚**

1. **è®­ç»ƒè¿‡ç¨‹**:
   - âœ… `outputs.loss` - ç”¨äºåå‘ä¼ æ’­
   - âœ… `outputs.logits` - ç”¨äºè®¡ç®—é¢„æµ‹å’ŒæŒ‡æ ‡
   - âŒ `outputs.hidden_states` - **å®Œå…¨æ²¡æœ‰ä½¿ç”¨**
   - âŒ `outputs.attentions` - **å®Œå…¨æ²¡æœ‰ä½¿ç”¨**

2. **è¯„ä¼°è¿‡ç¨‹**:
   - âœ… `outputs.loss` - ç”¨äºè®¡ç®—è¯„ä¼°æŸå¤±
   - âœ… `outputs.logits` - ç”¨äºè®¡ç®—å‡†ç¡®ç‡
   - âŒ `outputs.hidden_states` - **å®Œå…¨æ²¡æœ‰ä½¿ç”¨**
   - âŒ `outputs.attentions` - **å®Œå…¨æ²¡æœ‰ä½¿ç”¨**

3. **ç›‘æ§ç³»ç»Ÿ**:
   - åªéœ€è¦ `outputs.last_hidden_state.size(1)` è·å–åºåˆ—é•¿åº¦
   - **ä¸éœ€è¦å®Œæ•´çš„hidden_states tensor**

## ğŸ”§ V3ä¿®å¤æ–¹æ¡ˆï¼ˆç»ˆæç‰ˆï¼‰

### ç»Ÿä¸€ç®€åŒ–æ¨¡å‹è¾“å‡º

```python
def forward(self, ...):
    # ... å‰å‘ä¼ æ’­å’ŒæŸå¤±è®¡ç®— ...
    
    # ğŸ”¥ ç»ˆæä¿®å¤ï¼šæ— è®ºè®­ç»ƒè¿˜æ˜¯è¯„ä¼°éƒ½ä¸è¿”å›å¤§tensor
    # ç»è¿‡ä»£ç åˆ†æç¡®è®¤ï¼šè®­ç»ƒå’Œè¯„ä¼°è¿‡ç¨‹ä¸­éƒ½ä¸éœ€è¦hidden_stateså’Œattentions
    # åªéœ€è¦losså’Œlogitsè¿›è¡Œåå‘ä¼ æ’­å’Œé¢„æµ‹è®¡ç®—
    
    print(f"ğŸ” æ¨¡å‹è¾“å‡ºç®€åŒ–: self.training={self.training}, åªè¿”å›losså’Œlogits")
    
    # ç»Ÿä¸€è¿”å›ç®€åŒ–è¾“å‡º - å¤§å¹…èŠ‚çœå†…å­˜å’Œé€šä¿¡å¸¦å®½
    return SequenceClassifierOutput(
        loss=loss,
        logits=logits,
        hidden_states=None,  # âœ… è®­ç»ƒå’Œè¯„ä¼°éƒ½ä¸éœ€è¦ï¼Œé¿å…4.67äº¿å…ƒç´ çš„NCCL reduce
        attentions=None,     # âœ… è®­ç»ƒå’Œè¯„ä¼°éƒ½ä¸éœ€è¦ï¼ŒèŠ‚çœå†…å­˜å’Œé€šä¿¡å¸¦å®½
    )
```

### ä¸å†éœ€è¦å¤æ‚çš„æ¨¡å¼æ£€æµ‹

- âŒ ä¸å†éœ€è¦æ£€æµ‹ `self.training` çŠ¶æ€
- âŒ ä¸å†éœ€è¦å¤„ç† DeepSpeed åŒ…è£…é—®é¢˜
- âŒ ä¸å†éœ€è¦åˆ†åˆ«å¤„ç†è®­ç»ƒå’Œè¯„ä¼°æ¨¡å¼
- âœ… ç»Ÿä¸€ç®€åŒ–è¾“å‡ºï¼Œä»£ç æ›´ç®€æ´å¯é 

## ğŸ“Š é¢„æœŸæ•ˆæœï¼ˆæ˜¾è‘—æå‡ï¼‰

### NCCLè¶…æ—¶å®Œå…¨æ¶ˆé™¤
- **V1æ•ˆæœ**: ä»ç„¶4.67äº¿å…ƒç´ è¶…æ—¶
- **V2æ•ˆæœ**: è¯„ä¼°æ—¶æ¶ˆé™¤ï¼Œè®­ç»ƒæ—¶ä»æœ‰å¼€é”€
- **V3æ•ˆæœ**: è®­ç»ƒå’Œè¯„ä¼°éƒ½æ¶ˆé™¤ï¼Œ0ä¸ªNCCLè¶…æ—¶é”™è¯¯

### å†…å­˜èŠ‚çœï¼ˆç¿»å€æå‡ï¼‰
- **å•GPU**: ~235MB (æ¯æ¬¡å‰å‘ä¼ æ’­)
- **8GPUæ€»è®¡**: ~1.88GB (æ¯æ¬¡å‰å‘ä¼ æ’­)
- **è®­ç»ƒå…¨ç¨‹**: èŠ‚çœæ•°ç™¾GBå†…å­˜åˆ†é…

### æ€§èƒ½æå‡ï¼ˆå…¨é¢ä¼˜åŒ–ï¼‰
- **è®­ç»ƒé€Ÿåº¦**: 20-40%æå‡ï¼ˆå‡å°‘å†…å­˜åˆ†é…å’Œä¼ è¾“ï¼‰
- **è¯„ä¼°é€Ÿåº¦**: 80-90%æå‡
- **å†…å­˜ä½¿ç”¨**: å…¨ç¨‹é™ä½1.88GB
- **é€šä¿¡å¸¦å®½**: é¿å…æ‰€æœ‰hidden_statesä¼ è¾“

### ç¨³å®šæ€§æ”¹å–„ï¼ˆè´¨çš„é£è·ƒï¼‰
- **NCCLè¶…æ—¶**: è®­ç»ƒå’Œè¯„ä¼°éƒ½100%æ¶ˆé™¤
- **å†…å­˜ç¨³å®šæ€§**: é¿å…è®­ç»ƒè¿‡ç¨‹ä¸­çš„å†…å­˜å³°å€¼
- **è®­ç»ƒè¿ç»­æ€§**: å½»åº•è§£å†³ä¸­æ–­é—®é¢˜

## ğŸ” æŠ€æœ¯æ·±åº¦åˆ†æ

### ä¸ºä»€ä¹ˆè®­ç»ƒæ—¶ä¹Ÿå¯ä»¥ä¸è¿”å›hidden_statesï¼Ÿ

1. **åå‘ä¼ æ’­æœºåˆ¶**: PyTorchåªéœ€è¦computational graphï¼Œä¸éœ€è¦å­˜å‚¨ä¸­é—´hidden_states
2. **æ¢¯åº¦è®¡ç®—**: æ¢¯åº¦é€šè¿‡automatic differentiationè®¡ç®—ï¼Œä¸ä¾èµ–è¿”å›çš„hidden_states
3. **æŸå¤±è®¡ç®—**: åªéœ€è¦æœ€ç»ˆçš„logitså’Œlossï¼Œä¸­é—´çŠ¶æ€å¯ä»¥é‡Šæ”¾

### V3ç›¸æ¯”V1/V2çš„ä¼˜åŠ¿

| æ–¹é¢ | V1 (åŸå§‹) | V2 (æ¡ä»¶å¼) | V3 (ç»ˆæç‰ˆ) |
|------|-----------|-------------|------------|
| **ä»£ç å¤æ‚åº¦** | ä½ | é«˜ | âœ… æä½ |
| **å†…å­˜èŠ‚çœ** | è¯„ä¼°æ—¶ | è¯„ä¼°æ—¶ | âœ… è®­ç»ƒ+è¯„ä¼° |
| **æ€§èƒ½æå‡** | æœ‰é™ | ä¸­ç­‰ | âœ… æ˜¾è‘— |
| **ç¨³å®šæ€§** | å·® | ä¸­ç­‰ | âœ… æä½³ |
| **ç»´æŠ¤æ€§** | å·® | å¤æ‚ | âœ… ç®€å• |

### å…¼å®¹æ€§ä¿è¯

- âœ… ä¸å½±å“ç°æœ‰è®­ç»ƒé€»è¾‘
- âœ… ä¸å½±å“æ¨¡å‹æ¨ç†
- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… å¯éšæ—¶å›æ»š

## ğŸ§ª éªŒè¯æ–¹æ³•

### æŸ¥çœ‹è®­ç»ƒæ—¥å¿—

è¿è¡Œè®­ç»ƒæ—¶ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ” æ¨¡å‹è¾“å‡ºç®€åŒ–: self.training=True, åªè¿”å›losså’Œlogits
ğŸ” æ¨¡å‹è¾“å‡ºç®€åŒ–: self.training=False, åªè¿”å›losså’Œlogits
```

### æ€§èƒ½ç›‘æ§

- **GPUå†…å­˜ä½¿ç”¨**: æŒç»­é™ä½1.88GB
- **è®­ç»ƒé€Ÿåº¦**: æ¯æ­¥æ—¶é—´å‡å°‘20-40%
- **NCCLé€šä¿¡**: å®Œå…¨æ²¡æœ‰4.67äº¿å…ƒç´ çš„all_reduce

## ğŸ¯ ä¿®å¤æ¼”è¿›å†ç¨‹

### V1é—®é¢˜ï¼ˆå¤±æ•ˆï¼‰
```python
if not self.training:  # âŒ åªæ£€æŸ¥è¯„ä¼°ï¼Œè®­ç»ƒæ—¶ä»è¿”å›å¤§tensor
    return SequenceClassifierOutput(hidden_states=None)
else:
    return SequenceClassifierOutput(hidden_states=outputs.hidden_states)  # âš ï¸ ä»æœ‰å¼€é”€
```

### V2ä¿®å¤ï¼ˆå¤æ‚ï¼‰
```python
is_eval_mode = not self.training
if hasattr(self, 'model') and hasattr(self.model, 'training'):  # ğŸ”§ å¤æ‚çš„æ£€æµ‹é€»è¾‘
    is_eval_mode = is_eval_mode or not self.model.training

if is_eval_mode:  # âš ï¸ ä»éœ€è¦æ¨¡å¼åˆ¤æ–­
    return SequenceClassifierOutput(hidden_states=None)
else:
    return SequenceClassifierOutput(hidden_states=outputs.hidden_states)
```

### V3ç»ˆæç‰ˆï¼ˆå®Œç¾ï¼‰
```python
# âœ… æ— æ¡ä»¶ç»Ÿä¸€ç®€åŒ–ï¼Œä»£ç æç®€ä¸”é«˜æ•ˆ
return SequenceClassifierOutput(
    loss=loss,
    logits=logits,
    hidden_states=None,  # è®­ç»ƒå’Œè¯„ä¼°éƒ½ä¸éœ€è¦
    attentions=None,     # è®­ç»ƒå’Œè¯„ä¼°éƒ½ä¸éœ€è¦
)
```

## ğŸš€ ä½¿ç”¨å»ºè®®

### ç«‹å³è·å¾—çš„æ”¶ç›Š

1. **å½»åº•è§£å†³NCCLè¶…æ—¶** - è®­ç»ƒå’Œè¯„ä¼°éƒ½ç¨³å®š
2. **æ˜¾è‘—æå‡æ€§èƒ½** - è®­ç»ƒé€Ÿåº¦æå‡20-40%
3. **å¤§å¹…èŠ‚çœå†…å­˜** - å…¨ç¨‹èŠ‚çœ1.88GB
4. **ä»£ç æ›´ç®€æ´** - ç§»é™¤å¤æ‚çš„æ¡ä»¶åˆ¤æ–­

### é•¿æœŸæ”¶ç›Š

1. **è®­ç»ƒæˆæœ¬é™ä½** - æ›´é«˜çš„GPUåˆ©ç”¨ç‡
2. **æ¨¡å‹è¿­ä»£åŠ é€Ÿ** - æ›´å¿«çš„å®éªŒå‘¨æœŸ
3. **ç»´æŠ¤æˆæœ¬é™ä½** - æ›´ç®€å•çš„ä»£ç é€»è¾‘

è¿™ä¸ªV3ç»ˆæç‰ˆä¿®å¤æ˜¯å¯¹æ·±åº¦å­¦ä¹ è®­ç»ƒä¼˜åŒ–çš„ä¸€ä¸ªå®Œç¾ç¤ºä¾‹ï¼ğŸ‰ 