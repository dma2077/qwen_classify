model:
  pretrained_name: "/llm_reco/dehua/model/Qwen2.5-VL-7B-Instruct"
  num_labels: 2000  # æ‰€æœ‰æ•°æ®é›†ä¸­çš„æœ€å¤§ç±»åˆ«æ•°

# ğŸ”¥ ä½¿ç”¨æœ€ç¨³å®šçš„æŸå¤±å‡½æ•°
loss:
  type: "cross_entropy"  # æœ€ç¨³å®šçš„é€‰æ‹©

# å¤šæ•°æ®é›†é…ç½® - ç¨³å®šç‰ˆ
datasets:
  dataset_configs:
    food101:
      num_classes: 101
      description: "Food-101 dataset"
      eval_ratio: 0.2
    food2k:
      num_classes: 2000
      description: "Food2K dataset"
      eval_ratio: 0.1
    food172:
      num_classes: 172
      description: "Food172 dataset"
      eval_ratio: 0.2
    foodx251:
      num_classes: 251
      description: "foodx251 dataset"
      eval_ratio: 0.2
    fru92:
      num_classes: 92
      description: "fru92 dataset"
      eval_ratio: 0.2
    veg200:
      num_classes: 200
      description: "veg200 dataset"
      eval_ratio: 0.2
  
  # ğŸ”¥ æš‚æ—¶ç¦ç”¨logits maskingä»¥æ’é™¤é—®é¢˜
  enable_logits_masking: false
  shuffle_datasets: true

# æ•°æ®æ–‡ä»¶é…ç½®
data:
  train_jsonl_list:
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/food101_train.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/food2k_train.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/food172_train.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/foodx251_train.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/fru92_train.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/veg200_train.jsonl"
  val_jsonl_list:
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/food101_test.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/food2k_test.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/food172_test.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/foodx251_test.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/fru92_test.jsonl"
    - "/llm_reco/dehua/code/qwen_classify/data/dataset_food_label/veg200_test.jsonl"

training:
  epochs: 3  # å‡å°‘epochæ•°ç”¨äºå¿«é€Ÿæµ‹è¯•
  lr: 1e-6   # ğŸ”¥ å¤§å¹…é™ä½å­¦ä¹ ç‡
  weight_decay: 0.01
  warmup_steps: 100
  max_grad_norm: 1.0  # ğŸ”¥ æ·»åŠ æ¢¯åº¦è£å‰ª
  output_dir: "/mmu_mllm_hdd_2/madehua/model/qwen_classify/multi_dataset_stable"
  logging_steps: 20
  save_steps: 200
  eval_steps: 100  # æ›´é¢‘ç¹çš„è¯„ä¼°ä»¥ç›‘æ§ç¨³å®šæ€§
  save_hf_format: true
  save_deepspeed_format: false
  num_workers: 8

  # ğŸ”¥ æ•°å€¼ç¨³å®šæ€§é…ç½®
  numerical_stability:
    check_inf_loss: true
    clip_logits: true
    logits_clip_value: 10.0
    use_stable_softmax: true

  # æœ€ä½³æ¨¡å‹è¿½è¸ª
  best_model_tracking:
    enabled: true
    metric: "overall_accuracy"
    mode: "max"
    save_best_only: false  # ä¿å­˜æ›´å¤šcheckpointç”¨äºè°ƒè¯•

  # è¯„ä¼°é…ç½®
  evaluation:
    partial_eval_during_training: true
    full_eval_at_end: true
    eval_best_model_only: false

# ä¼˜åŒ–å™¨é…ç½® - æ›´ä¿å®ˆçš„è®¾ç½®
optimizer:
  type: "adamw"
  lr: 1e-6
  weight_decay: 0.01
  eps: 1e-8
  betas: [0.9, 0.999]

# å­¦ä¹ ç‡è°ƒåº¦å™¨ - æ›´ç¨³å®šçš„è®¾ç½®
lr_scheduler:
  type: "cosine"
  warmup_steps: 100
  min_lr_ratio: 0.1
  num_cycles: 0.5

# DeepSpeedé…ç½® - ç¨³å®šæ€§ä¼˜å…ˆ
deepspeed:
  config_path: "configs/ds_s2_stable.json"

# ç›‘æ§é…ç½®
monitor:
  freq:
    training_log_freq: 10
    eval_log_freq: 1
    perf_log_freq: 50
    gpu_log_freq: 50
    flops_profile_freq: 100
    local_save_freq: 200
    progress_update_freq: 20

# WandBé…ç½®
wandb:
  enabled: true
  project: "qwen_classify_stable"
  name: "multi_dataset_stable_test"
  log_code: false
  log_dataset_metrics: true
  
# ğŸ”¥ é¢å¤–çš„ç¨³å®šæ€§è®¾ç½®
stability:
  # æ£€æµ‹åˆ°inf lossæ—¶çš„å¤„ç†
  inf_loss_handling:
    enabled: true
    fallback_loss_value: 1.0
    max_inf_count: 10  # è¿ç»­10æ¬¡inf lossååœæ­¢è®­ç»ƒ
  
  # logitsæ•°å€¼èŒƒå›´æ§åˆ¶
  logits_control:
    enabled: true
    clip_value: 50.0
    check_nan: true
  
  # æ ‡ç­¾éªŒè¯
  label_validation:
    enabled: true
    check_bounds: true
    auto_fix: true

# ğŸ“‹ ä½¿ç”¨è¯´æ˜:
# 1. è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸“é—¨ç”¨äºè§£å†³å¤šæ•°æ®é›†è®­ç»ƒä¸­çš„Loss=infé—®é¢˜
# 2. ä¸»è¦ä¿®å¤æªæ–½:
#    - é™ä½å­¦ä¹ ç‡åˆ°1e-6
#    - æ·»åŠ æ¢¯åº¦è£å‰ª
#    - æš‚æ—¶ç¦ç”¨logits masking
#    - ä½¿ç”¨æœ€ç¨³å®šçš„CrossEntropyæŸå¤±
#    - æ·»åŠ å„ç§æ•°å€¼ç¨³å®šæ€§æ£€æŸ¥
# 3. ä½¿ç”¨æ–¹æ³•:
#    python scripts/diagnose_inf_loss.py configs/your_original_config.yaml
#    ç„¶åä½¿ç”¨ç”Ÿæˆçš„_fixed.yamlæ–‡ä»¶ï¼Œæˆ–ç›´æ¥ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿ 