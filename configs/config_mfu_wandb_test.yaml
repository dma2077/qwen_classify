# MFUå’ŒFLOPsåœ¨WandBä¸­æ˜¾ç¤ºçš„æµ‹è¯•é…ç½®

# åŸºç¡€è®­ç»ƒé…ç½®
training:
  num_epochs: 2  # çŸ­è®­ç»ƒç”¨äºæµ‹è¯•
  logging_steps: 1  # æ¯æ­¥éƒ½è®°å½•
  save_steps: 50
  eval_steps: 10  # é¢‘ç¹è¯„ä¼°
  
  # è¯„ä¼°é…ç½®
  evaluation:
    partial_eval_during_training: true
    full_eval_at_end: true
    eval_best_model_only: true
  
  # æœ€ä½³æ¨¡å‹è¿½è¸ª
  best_model_tracking:
    enabled: true
    metric: "overall_accuracy"
    mode: "max"
    save_best_only: true

# ğŸ”¥ å…³é”®é…ç½®ï¼šç›‘æ§é¢‘ç‡è®¾ç½® - ç¡®ä¿MFUå’ŒFLOPsæŒ‡æ ‡èƒ½æ˜¾ç¤º
monitor:
  freq:
    training_log_freq: 1        # æ¯æ­¥è®°å½•è®­ç»ƒæŒ‡æ ‡
    eval_log_freq: 1            # æ¯æ­¥è®°å½•è¯„ä¼°æŒ‡æ ‡
    perf_log_freq: 1            # æ¯æ­¥è®°å½•æ€§èƒ½æŒ‡æ ‡
    gpu_log_freq: 1             # æ¯æ­¥è®°å½•GPUæŒ‡æ ‡
    flops_profile_freq: 5       # æ¯5æ­¥è®¡ç®—MFU (ä¸è¦å¤ªé¢‘ç¹)
    local_save_freq: 20         # æ¯20æ­¥ä¿å­˜æœ¬åœ°æ—¥å¿—
    progress_update_freq: 1     # æ¯æ­¥æ›´æ–°è¿›åº¦

# æ•°æ®é›†é…ç½®
datasets:
  dataset_configs:
    food101:
      name: "food101"
      num_classes: 101
      eval_split: "validation"

# DeepSpeedé…ç½®
deepspeed:
  train_micro_batch_size_per_gpu: 4
  gradient_accumulation_steps: 4
  train_batch_size: 64
  steps_per_print: 1  # æ¯æ­¥éƒ½æ‰“å°
  
  # ä¼˜åŒ–å™¨é…ç½®
  optimizer:
    type: "AdamW"
    params:
      lr: 1e-5
      weight_decay: 0.01
      eps: 1e-8
  
  # å­¦ä¹ ç‡è°ƒåº¦å™¨
  scheduler:
    type: "WarmupLR"
    params:
      warmup_min_lr: 0
      warmup_max_lr: 1e-5
      warmup_num_steps: 50
  
  # ZeROä¼˜åŒ–
  zero_optimization:
    stage: 2
    offload_optimizer:
      device: "cpu"
      pin_memory: true
    offload_param:
      device: "cpu"
      pin_memory: true
    overlap_comm: true
    contiguous_gradients: true
    reduce_bucket_size: 5e8
    stage3_prefetch_bucket_size: 5e8
    stage3_param_persistence_threshold: 5e6
    sub_group_size: 1e9
    stage3_max_live_parameters: 1e9
    stage3_max_reuse_distance: 1e9
    stage3_gather_16bit_weights_on_model_save: true

# æ¨¡å‹é…ç½®
model:
  name: "Qwen/Qwen2.5-VL-7B-Instruct"
  revision: "main"
  torch_dtype: "bfloat16"
  device_map: "auto"
  trust_remote_code: true
  max_sequence_length: 512

# æ•°æ®åŠ è½½å™¨é…ç½®
data:
  train_batch_size: 64
  eval_batch_size: 64
  num_workers: 4
  pin_memory: true
  persistent_workers: true

# è¾“å‡ºé…ç½®
output_dir: "./outputs/mfu_wandb_test"
save_deepspeed_format: true
save_hf_format: true

# ğŸ”¥ å…³é”®é…ç½®ï¼šWandBé…ç½® - ç¡®ä¿MFUå’ŒFLOPsæŒ‡æ ‡æ­£ç¡®æ˜¾ç¤º
wandb:
  enabled: true
  project: "qwen-classify-mfu-wandb-test"
  name: "mfu-flops-wandb-display-test"
  log_dataset_metrics: true
  
  # æŒ‡æ ‡é…ç½® - æ˜ç¡®æŒ‡å®šè¦è®°å½•çš„æŒ‡æ ‡
  metrics:
    # è®­ç»ƒæŒ‡æ ‡
    training:
      - "training/loss"
      - "training/learning_rate"
      - "training/grad_norm"
      - "training/epoch"
    
    # è¯„ä¼°æŒ‡æ ‡
    evaluation:
      - "eval/overall_loss"
      - "eval/overall_accuracy"
      - "eval/food101_accuracy"
    
    # ğŸ”¥ å…³é”®ï¼šæ€§èƒ½æŒ‡æ ‡ - ç¡®ä¿MFUå’ŒFLOPsæŒ‡æ ‡è¢«è®°å½•
    performance:
      - "perf/mfu"
      - "perf/mfu_percent"
      - "perf/step_time"
      - "perf/steps_per_second"
      - "perf/tokens_per_second"
      - "perf/samples_per_second"
      - "perf/actual_flops"
      - "perf/flops_per_second"
      - "perf/actual_seq_length"
      - "perf/gpu_memory_allocated_gb"
      - "perf/gpu_memory_utilization_percent"

# æ—¥å¿—é…ç½®
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# ä½¿ç”¨è¯´æ˜
usage_notes: |
  # MFUå’ŒFLOPsåœ¨WandBä¸­æ˜¾ç¤ºçš„æµ‹è¯•é…ç½®
  
  ## æ ¸å¿ƒç‰¹æ€§
  - æ¯æ­¥éƒ½è®°å½•æ‰€æœ‰æŒ‡æ ‡ï¼Œç¡®ä¿èƒ½çœ‹åˆ°MFUå’ŒFLOPs
  - æ¯5æ­¥ä½¿ç”¨profilerè®¡ç®—ä¸€æ¬¡MFU
  - æ˜ç¡®æŒ‡å®šWandBè¦è®°å½•çš„æŒ‡æ ‡
  
  ## å…³é”®é…ç½®è¯´æ˜
  
  ### ç›‘æ§é¢‘ç‡
  - training_log_freq: 1 - æ¯æ­¥è®°å½•è®­ç»ƒæŒ‡æ ‡
  - perf_log_freq: 1 - æ¯æ­¥è®°å½•æ€§èƒ½æŒ‡æ ‡
  - flops_profile_freq: 5 - æ¯5æ­¥è®¡ç®—MFU
  
  ### WandBæŒ‡æ ‡
  - perf/mfu: Model FLOPs Utilization (0-1)
  - perf/mfu_percent: MFUç™¾åˆ†æ¯” (0-100%)
  - perf/actual_flops: å®é™…FLOPsæ•°é‡
  - perf/flops_per_second: æ¯ç§’FLOPs
  - perf/tokens_per_second: æ¯ç§’å¤„ç†çš„tokenæ•°
  - perf/samples_per_second: æ¯ç§’å¤„ç†çš„æ ·æœ¬æ•°
  
  ## åœ¨WandBä¸­æŸ¥æ‰¾æŒ‡æ ‡
  
  ### 1. æ€§èƒ½æŒ‡æ ‡ç»„ (perf/)
  åœ¨WandBç•Œé¢ä¸­æŸ¥æ‰¾ä»¥ä¸‹æŒ‡æ ‡ï¼š
  - perf/mfu
  - perf/mfu_percent
  - perf/actual_flops
  - perf/flops_per_second
  - perf/tokens_per_second
  - perf/samples_per_second
  
  ### 2. è®­ç»ƒæŒ‡æ ‡ç»„ (training/)
  - training/loss
  - training/learning_rate
  - training/grad_norm
  
  ### 3. è¯„ä¼°æŒ‡æ ‡ç»„ (eval/)
  - eval/overall_loss
  - eval/overall_accuracy
  
  ## è°ƒè¯•å»ºè®®
  
  ### å¦‚æœæŒ‡æ ‡ä¸æ˜¾ç¤ºï¼š
  1. æ£€æŸ¥WandBè¿è¡Œæ—¥å¿—ï¼Œç¡®è®¤æŒ‡æ ‡æ˜¯å¦æˆåŠŸå‘é€
  2. éªŒè¯æŒ‡æ ‡åç§°æ˜¯å¦æ­£ç¡® (perf/mfu, perf/actual_flops)
  3. ç¡®è®¤æŒ‡æ ‡å€¼æ˜¯å¦ä¸ºæ•°å€¼ç±»å‹
  4. æ£€æŸ¥WandBç•Œé¢ä¸­çš„åˆ†ç»„è®¾ç½®
  
  ### å¦‚æœMFUå€¼ä¸º0ï¼š
  1. æ£€æŸ¥flops_profile_freqè®¾ç½®
  2. ç¡®è®¤actual_flopsæ˜¯å¦æ­£ç¡®è®¾ç½®
  3. éªŒè¯æ¨¡å‹å¼•ç”¨æ˜¯å¦æ­£ç¡®
  4. æ£€æŸ¥profileræ˜¯å¦æ­£å¸¸å·¥ä½œ
  
  ### å¦‚æœæŒ‡æ ‡åˆ†ç»„ä¸æ­£ç¡®ï¼š
  1. ç¡®ä¿æŒ‡æ ‡åç§°åŒ…å«åˆ†ç»„å‰ç¼€ (perf/, training/, eval/)
  2. æ£€æŸ¥WandBç•Œé¢ä¸­çš„åˆ†ç»„è®¾ç½®
  3. é‡æ–°å¯åŠ¨WandBè¿è¡Œ
  
  ## é¢„æœŸç»“æœ
  
  è¿è¡Œæ­¤é…ç½®åï¼Œä½ åº”è¯¥èƒ½åœ¨WandBç•Œé¢ä¸­çœ‹åˆ°ï¼š
  - æ¯æ­¥éƒ½æœ‰è®­ç»ƒæŒ‡æ ‡è®°å½•
  - æ¯5æ­¥æœ‰MFUå€¼ï¼ˆå…¶ä»–æ­¥éª¤MFUä¸º0ï¼‰
  - æ¯æ­¥éƒ½æœ‰FLOPsç›¸å…³æŒ‡æ ‡
  - æŒ‡æ ‡æŒ‰åˆ†ç»„æ­£ç¡®æ˜¾ç¤º 