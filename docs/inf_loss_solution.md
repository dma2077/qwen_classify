# å¤šæ•°æ®é›†è®­ç»ƒLoss=infé—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜æè¿°

åœ¨å¤šæ•°æ®é›†è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰æ•°æ®é›†çš„Losséƒ½æ˜¾ç¤ºä¸º`inf`ï¼ˆæ— ç©·å¤§ï¼‰ï¼Œä½†å‡†ç¡®ç‡å¾ˆä½ä½†éé›¶ï¼š

```
ğŸ“Š æ£€æµ‹åˆ°å¤šæ•°æ®é›†è¯„ä¼°ç»“æœ:
  ğŸ“‚ food101: Loss: inf, Accuracy: 0.0097 (0.97%)
  ğŸ“‚ food172: Loss: inf, Accuracy: 0.0035 (0.35%)
  ğŸ“‚ foodx251: Loss: inf, Accuracy: 0.0050 (0.50%)
  ğŸ“‚ food2k: Loss: inf, Accuracy: 0.0010 (0.10%)
  ğŸ“‚ fru92: Loss: inf, Accuracy: 0.0169 (1.69%)
  ğŸ“‚ veg200: Loss: inf, Accuracy: 0.0054 (0.54%)
```

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### 1. **Logits Maskingè¿‡åº¦**
- å¤šæ•°æ®é›†æ¨¡å¼ä¸‹ï¼Œ`_apply_logits_masking`å°†æ— æ•ˆç±»åˆ«çš„logitsè®¾ä¸º`float('-inf')`
- å¦‚æœæ ‡ç­¾æ˜ å°„é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´æ‰€æœ‰æœ‰æ•ˆä½ç½®éƒ½è¢«mask
- `-inf`å€¼åœ¨softmaxè®¡ç®—ä¸­å¯èƒ½å¯¼è‡´æ•°å€¼ä¸ç¨³å®š

### 2. **æ ‡ç­¾è¶Šç•Œé—®é¢˜**
- æ•°æ®é›†ä¸­çš„æ ‡ç­¾å¯èƒ½è¶…å‡ºäº†é…ç½®çš„ç±»åˆ«èŒƒå›´
- ä¾‹å¦‚ï¼šfood101é…ç½®101ä¸ªç±»åˆ«ï¼Œä½†æ•°æ®ä¸­å‡ºç°äº†æ ‡ç­¾101ï¼ˆåº”è¯¥æ˜¯0-100ï¼‰

### 3. **æ•°å€¼æº¢å‡º**
- å¤šæ•°æ®é›†æ··åˆè®­ç»ƒæ—¶ï¼Œä¸åŒscaleçš„æŸå¤±å¯èƒ½å¯¼è‡´æ¢¯åº¦çˆ†ç‚¸
- æ··åˆç²¾åº¦ï¼ˆbf16ï¼‰åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½åŠ å‰§æ•°å€¼é—®é¢˜

### 4. **å­¦ä¹ ç‡è¿‡å¤§**
- è¿‡å¤§çš„å­¦ä¹ ç‡å¯èƒ½å¯¼è‡´æ¢¯åº¦çˆ†ç‚¸ï¼Œè¿›è€Œäº§ç”Ÿinf loss

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### ç«‹å³è§£å†³æ–¹æ¡ˆ

#### 1. ä½¿ç”¨è¯Šæ–­è„šæœ¬
```bash
# è¯Šæ–­å½“å‰é…ç½®çš„é—®é¢˜
python scripts/diagnose_inf_loss.py configs/your_config.yaml

# ä¼šç”Ÿæˆä¸€ä¸ª your_config_fixed.yaml æ–‡ä»¶
```

#### 2. ä½¿ç”¨ç¨³å®šé…ç½®æ¨¡æ¿
```bash
# ç›´æ¥ä½¿ç”¨é¢„é…ç½®çš„ç¨³å®šæ¨¡æ¿
cp configs/multi_dataset_stable.yaml configs/your_stable_config.yaml
# æ ¹æ®éœ€è¦ä¿®æ”¹æ•°æ®è·¯å¾„
```

### ä»£ç çº§ä¿®å¤

#### 1. **Logits Maskingæ”¹è¿›**
- âœ… ä½¿ç”¨`-1e9`ä»£æ›¿`float('-inf')`
- âœ… æ·»åŠ logitsæ•°å€¼èŒƒå›´è£å‰ªï¼ˆ-50åˆ°50ï¼‰
- âœ… æ£€æŸ¥æœ‰æ•ˆä½ç½®ä¸å…¨ä¸ºæå°å€¼

```python
# ä¿®å¤å‰
masked_logits[i, num_classes:] = float('-inf')

# ä¿®å¤å  
mask_value = -1e9
masked_logits[i, num_classes:] = mask_value
```

#### 2. **æŸå¤±è®¡ç®—æ•°å€¼ç¨³å®šæ€§**
- âœ… æ ‡ç­¾è¾¹ç•Œæ£€æŸ¥å’Œè‡ªåŠ¨è£å‰ª
- âœ… Logits NaN/Infæ£€æµ‹å’Œæ¸…ç†
- âœ… æŸå¤±ç»“æœéªŒè¯å’Œå›é€€æœºåˆ¶

```python
# æ ‡ç­¾è¾¹ç•Œæ£€æŸ¥
if max_label >= logits.size(-1):
    labels = torch.clamp(labels, min=0, max=logits.size(-1)-1)

# NaN/Infæ¸…ç†
if torch.any(torch.isnan(logits)) or torch.any(torch.isinf(logits)):
    logits = torch.nan_to_num(logits, nan=0.0, posinf=1e9, neginf=-1e9)
```

#### 3. **é…ç½®ä¼˜åŒ–**
- âœ… é™ä½å­¦ä¹ ç‡ï¼š`1e-6`ï¼ˆä»`5e-6`ï¼‰
- âœ… æ·»åŠ æ¢¯åº¦è£å‰ªï¼š`max_grad_norm: 1.0`
- âœ… æš‚æ—¶ç¦ç”¨logits maskingï¼š`enable_logits_masking: false`
- âœ… ä½¿ç”¨æœ€ç¨³å®šçš„æŸå¤±å‡½æ•°ï¼š`type: "cross_entropy"`

## ğŸ“‹ æ¨èçš„è§£å†³æ­¥éª¤

### æ­¥éª¤1ï¼šè¯Šæ–­é—®é¢˜
```bash
python scripts/diagnose_inf_loss.py configs/your_current_config.yaml
```

### æ­¥éª¤2ï¼šåº”ç”¨å¿«é€Ÿä¿®å¤
ä½¿ç”¨ç”Ÿæˆçš„`_fixed.yaml`é…ç½®æ–‡ä»¶ï¼Œæˆ–è€…ï¼š

```yaml
# å…³é”®ä¿®å¤å‚æ•°
training:
  lr: 1e-6                    # å¤§å¹…é™ä½å­¦ä¹ ç‡
  max_grad_norm: 1.0         # æ·»åŠ æ¢¯åº¦è£å‰ª

datasets:
  enable_logits_masking: false  # æš‚æ—¶ç¦ç”¨

loss:
  type: "cross_entropy"      # ä½¿ç”¨æœ€ç¨³å®šçš„æŸå¤±
```

### æ­¥éª¤3ï¼šé€æ­¥é‡æ–°å¯ç”¨åŠŸèƒ½
ä¸€æ—¦è®­ç»ƒç¨³å®šï¼š
1. ç¡®è®¤æ•°æ®æ ‡ç­¾æ­£ç¡®æ€§
2. é€æ­¥æé«˜å­¦ä¹ ç‡ï¼ˆ1e-6 â†’ 2e-6 â†’ 5e-6ï¼‰
3. é‡æ–°å¯ç”¨logits maskingï¼ˆå¦‚æœéœ€è¦ï¼‰

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### ä½¿ç”¨æµ‹è¯•è„šæœ¬
```bash
# æµ‹è¯•ç®€åŒ–åçš„FLOPsè®¡ç®—
python scripts/test_simplified_flops.py

# æµ‹è¯•eval_ratioåŠŸèƒ½
python scripts/test_eval_ratio.py

# æµ‹è¯•skip_evaluationä¼˜å…ˆçº§
python scripts/test_skip_evaluation_priority.py
```

### ç›‘æ§è®­ç»ƒè¿‡ç¨‹
- ğŸ“Š Lossåº”è¯¥ä»é«˜å€¼ï¼ˆå¦‚1-10ï¼‰é€æ¸ä¸‹é™
- ğŸ“ˆ å‡†ç¡®ç‡åº”è¯¥é€æ­¥æå‡
- âš ï¸ å¦‚æœä»å‡ºç°infï¼Œæ£€æŸ¥æ•°æ®æ ‡ç­¾æ˜ å°„

## ğŸ”§ é«˜çº§è°ƒè¯•æŠ€å·§

### 1. æ£€æŸ¥æ•°æ®æ ‡ç­¾
```python
import json

# æ£€æŸ¥æ ‡ç­¾èŒƒå›´
with open('your_data.jsonl', 'r') as f:
    labels = []
    for line in f:
        item = json.loads(line)
        labels.append(item['label'])
    
print(f"æ ‡ç­¾èŒƒå›´: {min(labels)} - {max(labels)}")
print(f"å”¯ä¸€æ ‡ç­¾æ•°: {len(set(labels))}")
```

### 2. å°æ‰¹é‡æµ‹è¯•
```yaml
# ä½¿ç”¨å°æ•°æ®é›†æµ‹è¯•
datasets:
  dataset_configs:
    food101:
      num_classes: 101
      eval_ratio: 0.01  # åªä½¿ç”¨1%æ•°æ®æµ‹è¯•
```

### 3. å•æ•°æ®é›†éªŒè¯
```yaml
# å…ˆç”¨å•æ•°æ®é›†ç¡®ä¿ç¨³å®šæ€§
datasets:
  dataset_configs:
    food101:
      num_classes: 101
  enable_logits_masking: false
```

## ğŸ“ˆ æ€§èƒ½é¢„æœŸ

ä¿®å¤åçš„æœŸæœ›ç»“æœï¼š
- âœ… Loss: æ­£å¸¸æ•°å€¼ï¼ˆ1-10èŒƒå›´å¼€å§‹ï¼Œé€æ¸ä¸‹é™ï¼‰
- âœ… Accuracy: é€æ­¥æå‡ï¼ˆä»éšæœºçŒœæµ‹çš„åŸºçº¿å¼€å§‹ï¼‰
- âœ… Trainingç¨³å®šæ€§: æ— inf/nané—®é¢˜
- âœ… Memoryä½¿ç”¨: æ­£å¸¸èŒƒå›´

## ğŸš¨ é¢„é˜²æªæ–½

### 1. æ•°æ®éªŒè¯
- è®­ç»ƒå‰éªŒè¯æ‰€æœ‰æ ‡ç­¾åœ¨æ­£ç¡®èŒƒå›´å†…
- ç¡®ä¿æ•°æ®é›†é…ç½®çš„ç±»åˆ«æ•°ä¸å®é™…æ•°æ®åŒ¹é…

### 2. é…ç½®æ£€æŸ¥
- ä½¿ç”¨ä¿å®ˆçš„å­¦ä¹ ç‡å¼€å§‹è®­ç»ƒ
- æ€»æ˜¯å¯ç”¨æ¢¯åº¦è£å‰ª
- å¯¹æ–°çš„æŸå¤±å‡½æ•°å…ˆå°è§„æ¨¡æµ‹è¯•

### 3. ç›‘æ§æœºåˆ¶
- è®¾ç½®losså¼‚å¸¸æ£€æµ‹
- å®šæœŸä¿å­˜checkpoint
- ä½¿ç”¨WandBç­‰å·¥å…·ç›‘æ§è®­ç»ƒæ›²çº¿

## ğŸ’¡ æœ€ä½³å®è·µ

1. **æ¸è¿›å¼è®­ç»ƒ**: ä»ç®€å•é…ç½®å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚æ€§
2. **æ•°æ®è´¨é‡**: æŠ•å…¥æ—¶é—´éªŒè¯æ•°æ®æ ‡ç­¾çš„æ­£ç¡®æ€§
3. **é…ç½®ç‰ˆæœ¬æ§åˆ¶**: ä¿å­˜æ¯æ¬¡ä¿®æ”¹çš„é…ç½®æ–‡ä»¶
4. **åŠæ—©æ£€æµ‹**: åœ¨å‡ºç°inf lossæ—¶ç«‹å³åœæ­¢å¹¶è°ƒè¯•
5. **å¤‡ç”¨æ–¹æ¡ˆ**: å‡†å¤‡å¤šä¸ªç¨³å®šæ€§çº§åˆ«çš„é…ç½®æ–‡ä»¶

éµå¾ªè¿™äº›è§£å†³æ–¹æ¡ˆï¼Œåº”è¯¥èƒ½å¤Ÿå½»åº•è§£å†³å¤šæ•°æ®é›†è®­ç»ƒä¸­çš„Loss=infé—®é¢˜ã€‚ğŸ‰ 