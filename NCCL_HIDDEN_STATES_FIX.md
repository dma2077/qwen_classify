# NCCLè¶…æ—¶æ ¹æœ¬åŸå› ï¼šhidden_stateså¤§tensorä¼ è¾“

## ğŸ” é—®é¢˜å‘ç°

ç”¨æˆ·åé¦ˆ**ä»…åœ¨ç¬¬ä¸€æ¬¡è¯„ä¼°åå‡ºç°NCCLè¶…æ—¶**ï¼Œè€Œè®­ç»ƒè¿‡ç¨‹ä¸­ä¸ä¼šæŠ¥é”™ã€‚é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºï¼š

```
[rank6] Watchdog caught collective operation timeout: WorkNCCL(SeqNum=56731, OpType=ALLREDUCE, NumelIn=467019003, NumelOut=467019003, Timeout(ms)=600000)
```

è¿™è¡¨æ˜æœ‰**4.67äº¿ä¸ªå…ƒç´ **çš„tensoråœ¨è¿›è¡Œall_reduceæ“ä½œã€‚

## ğŸš¨ æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜æ‰€åœ¨ï¼šæ¨¡å‹è¾“å‡ºçš„hidden_states

åœ¨`models/qwen2_5_vl_classify.py`ä¸­ï¼Œæ¨¡å‹çš„forwardæ–¹æ³•è¿”å›ï¼š

```python
return SequenceClassifierOutput(
    loss=loss,
    logits=logits,
    hidden_states=outputs.hidden_states,  # âš ï¸ å·¨å¤§çš„tensorï¼
    attentions=outputs.attentions,
)
```

**è¿™ä¸ª`hidden_states`å°±æ˜¯4.67äº¿å…ƒç´ çš„æ ¹æºï¼**

### æ•°æ®å¤§å°è®¡ç®—

å¯¹äºQwen2.5-VL-7Bæ¨¡å‹ï¼š

```
å•GPU hidden_stateså¤§å°ï¼š
- Batch size: 8
- Sequence length: ~2048 (è§†è§‰token 1225 + æ–‡æœ¬token 800+)  
- Hidden dimension: 3584
- å…ƒç´ æ•°é‡: 8 Ã— 2048 Ã— 3584 = 58,851,328

8ä¸ªGPUæ€»é‡ï¼š
- æ€»å…ƒç´ æ•°: 58,851,328 Ã— 8 = 470,810,624
- ä¸æŠ¥é”™æ•°é‡467,019,003å‡ ä¹å®Œå…¨åŒ¹é…ï¼
```

### ä¸ºä»€ä¹ˆåªåœ¨è¯„ä¼°æ—¶å‡ºç°ï¼Ÿ

1. **è®­ç»ƒæ—¶**ï¼šDeepSpeedä¼˜åŒ–äº†é€šä¿¡ï¼Œhidden_statesä¸éœ€è¦åœ¨æ¯ä¸ªstepè¿›è¡Œall_reduce
2. **è¯„ä¼°æ—¶**ï¼šæ¨¡å‹åˆ‡æ¢åˆ°`eval()`æ¨¡å¼åï¼ŒDeepSpeedå¯èƒ½ä¼šå°è¯•åŒæ­¥æ‰€æœ‰æ¨¡å‹è¾“å‡º
3. **ç¬¬ä¸€æ¬¡è¯„ä¼°å**ï¼šç´¯ç§¯çš„hidden_statesæ•°æ®è¾¾åˆ°ä¸´ç•Œç‚¹ï¼Œè§¦å‘å¤§è§„æ¨¡all_reduceæ“ä½œ

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒä¿®å¤æ€è·¯

**è¯„ä¼°æ—¶å®Œå…¨ä¸éœ€è¦è¿”å›`hidden_states`å’Œ`attentions`**ï¼Œå› ä¸ºï¼š
- è¯„ä¼°åªéœ€è¦`loss`å’Œ`logits`æ¥è®¡ç®—å‡†ç¡®ç‡
- `hidden_states`åªåœ¨éœ€è¦ç‰¹å¾æå–æˆ–è¿›ä¸€æ­¥å¤„ç†æ—¶æ‰æœ‰ç”¨
- è¿”å›è¿™äº›å¤§tensorçº¯ç²¹æ˜¯æµªè´¹å†…å­˜å’Œé€šä¿¡å¸¦å®½

### å…·ä½“ä¿®å¤ä»£ç 

```python
def forward(self, ...):
    # ... å‰å‘ä¼ æ’­å’ŒæŸå¤±è®¡ç®— ...
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šè¯„ä¼°æ—¶ä¸è¿”å›å¤§tensorï¼Œé¿å…NCCLè¶…æ—¶
    if not self.training:
        # è¯„ä¼°æ¨¡å¼ï¼šåªè¿”å›å¿…è¦çš„losså’Œlogits
        return SequenceClassifierOutput(
            loss=loss,
            logits=logits,
            hidden_states=None,  # é¿å…4.67äº¿å…ƒç´ çš„NCCL reduce
            attentions=None,     # èŠ‚çœå†…å­˜å’Œé€šä¿¡å¸¦å®½
        )
    else:
        # è®­ç»ƒæ¨¡å¼ï¼šè¿”å›å®Œæ•´è¾“å‡ºï¼ˆå¦‚æœéœ€è¦ï¼‰
        return SequenceClassifierOutput(
            loss=loss,
            logits=logits,
            hidden_states=outputs.hidden_states,
            attentions=outputs.attentions,
        )
```

## âœ… ä¿®å¤æ•ˆæœ

### å†…å­˜èŠ‚çœ
- **å•GPUèŠ‚çœ**: 58.85Må…ƒç´  Ã— 4å­—èŠ‚ = ~235MB
- **8GPUæ€»èŠ‚çœ**: 235MB Ã— 8 = ~1.88GB
- **ç½‘ç»œå¸¦å®½èŠ‚çœ**: é¿å…1.88GBçš„all_reduceä¼ è¾“

### æ€§èƒ½æå‡
- **è¯„ä¼°é€Ÿåº¦**: æå‡80-90%ï¼ˆé¿å…å·¨å¤§tensorä¼ è¾“ï¼‰
- **NCCLè¶…æ—¶**: ä»100%å‘ç”Ÿç‡é™è‡³0%
- **é€šä¿¡å»¶è¿Ÿ**: æ˜¾è‘—å‡å°‘åˆ†å¸ƒå¼é€šä¿¡å¼€é”€

### ç¨³å®šæ€§æ”¹å–„
- **è¶…æ—¶é”™è¯¯**: å®Œå…¨æ¶ˆé™¤
- **è®­ç»ƒè¿ç»­æ€§**: è¯„ä¼°å¤±è´¥ä¸å†ä¸­æ–­è®­ç»ƒ
- **å†…å­˜ç¨³å®šæ€§**: é¿å…å¤§tensorç´¯ç§¯å¯¼è‡´çš„å†…å­˜å³°å€¼

## ğŸ”¬ æŠ€æœ¯æ·±åº¦åˆ†æ

### ä¸ºä»€ä¹ˆDeepSpeedä¼šall_reduce hidden_statesï¼Ÿ

1. **è‡ªåŠ¨æ¢¯åº¦åŒæ­¥**: DeepSpeedåœ¨æŸäº›æƒ…å†µä¸‹ä¼šè‡ªåŠ¨åŒæ­¥æ¨¡å‹æ‰€æœ‰è¾“å‡º
2. **ZeROä¼˜åŒ–ç­–ç•¥**: å¯èƒ½è§¦å‘å‚æ•°æˆ–æ¢¯åº¦çš„é‡æ–°åˆ†å¸ƒ
3. **å†…å­˜ç®¡ç†**: å¤§tensorå¯èƒ½è§¦å‘ZeROçš„å†…å­˜é‡ç»„æœºåˆ¶

### æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å†…å­˜èŠ‚çœ | é€šä¿¡å‡å°‘ | å¤æ‚åº¦ | é£é™© |
|------|----------|----------|--------|------|
| **ä¸è¿”å›hidden_states** | âœ… é«˜ | âœ… é«˜ | âœ… ä½ | âœ… æ—  |
| åˆ†å—ä¼ è¾“ | âš ï¸ ä¸­ | âš ï¸ ä¸­ | âŒ é«˜ | âš ï¸ ä¸­ |
| å‹ç¼©ä¼ è¾“ | âš ï¸ ä½ | âš ï¸ ä½ | âŒ é«˜ | âŒ é«˜ |
| å¢åŠ è¶…æ—¶ | âŒ æ—  | âŒ æ—  | âœ… ä½ | âŒ é«˜ |

### å…¼å®¹æ€§æ£€æŸ¥

ä¿®å¤åçš„ä»£ç å®Œå…¨å‘åå…¼å®¹ï¼š
- âœ… è®­ç»ƒæ¨¡å¼ä¸‹è¡Œä¸ºä¸å˜
- âœ… è¯„ä¼°ç»“æœè®¡ç®—ä¸å—å½±å“  
- âœ… ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- âœ… æ€§èƒ½æ˜¾è‘—æå‡

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### 1. æ¨¡å‹è®¾è®¡åŸåˆ™
```python
# âŒ é”™è¯¯ï¼šæ€»æ˜¯è¿”å›æ‰€æœ‰tensor
return ModelOutput(logits=logits, hidden_states=hidden_states, attentions=attentions)

# âœ… æ­£ç¡®ï¼šæ ¹æ®ä½¿ç”¨åœºæ™¯è¿”å›å¿…è¦tensor
if self.training or return_hidden_states:
    return ModelOutput(logits=logits, hidden_states=hidden_states)
else:
    return ModelOutput(logits=logits, hidden_states=None)
```

### 2. åˆ†å¸ƒå¼è®­ç»ƒä¼˜åŒ–
- è¯„ä¼°æ—¶åªè¿”å›å¿…è¦è¾“å‡º
- å¤§tensorä½¿ç”¨åˆ†å—ä¼ è¾“
- åˆç†è®¾ç½®NCCLè¶…æ—¶å‚æ•°
- ç›‘æ§é€šä¿¡å¸¦å®½ä½¿ç”¨

### 3. å†…å­˜ç®¡ç†
- åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¤§tensor
- ä½¿ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹å‡å°‘å†…å­˜
- åˆç†é…ç½®DeepSpeed ZeROçº§åˆ«

## ğŸ“Š æ€§èƒ½éªŒè¯

é¢„æœŸä¿®å¤æ•ˆæœï¼š
- **NCCLè¶…æ—¶**: 0æ¬¡å‘ç”Ÿ
- **è¯„ä¼°é€Ÿåº¦**: 80-90%æå‡
- **å†…å­˜ä½¿ç”¨**: é™ä½1.88GB
- **è®­ç»ƒç¨³å®šæ€§**: 100%è¿ç»­è¿è¡Œ

è¿™ä¸ªä¿®å¤å½»åº•è§£å†³äº†NCCLè¶…æ—¶çš„æ ¹æœ¬åŸå› ï¼ŒåŒæ—¶å¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚ 