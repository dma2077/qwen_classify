# è®­ç»ƒæ­¥éª¤æ€§èƒ½ä¼˜åŒ–ä¿®å¤

## ğŸš€ é—®é¢˜åˆ†æ

ç”¨æˆ·åé¦ˆï¼šè®­ç»ƒçš„stepä¸­ï¼Œä»£ç éå¸¸æ…¢ï¼Œè€Œä¸evalæ— å…³ï¼Œæ¯ä¸€æ¬¡çš„è®­ç»ƒéƒ½éœ€è¦èŠ±è´¹ç‰¹åˆ«å¤šçš„æ—¶é—´ã€‚

è¿›ä¸€æ­¥å‘ç°ï¼šå³ä½¿ä¼˜åŒ–äº†FLOPs profilingé¢‘ç‡ï¼ŒGPUè¯†åˆ«ä»åœ¨æ¯50æ­¥å‘ç”Ÿã€‚

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡æ·±å…¥åˆ†æä»£ç ï¼Œå‘ç°äº†å‡ ä¸ªä¸»è¦çš„æ€§èƒ½ç“¶é¢ˆï¼š

### 1. **FLOPs Profiling å¼€é”€** - æœ€å¤§ç“¶é¢ˆ
- **é—®é¢˜**: æ¯50æ­¥è¿›è¡ŒPyTorch Profileræµ‹é‡ï¼Œå¼€é”€å·¨å¤§
- **å½±å“**: PyTorch Profilerä¼šå¯¼è‡´20-50%çš„æ€§èƒ½æŸå¤±
- **é¢‘ç‡**: åŸæœ¬æ¯50ä¸ªæœ‰æ•ˆæ­¥éª¤é‡æ–°æµ‹é‡

### 2. **GPUè¯†åˆ«é‡å¤å¼€é”€** - æ–°å‘ç°çš„ç“¶é¢ˆ
- **é—®é¢˜**: æ¯æ¬¡`calculate_mfu()`è°ƒç”¨éƒ½é‡æ–°è¯†åˆ«GPU
- **å½±å“**: æ¯è¯¦ç»†è®°å½•æ­¥éª¤éƒ½è§¦å‘GPUè¯†åˆ«
- **é¢‘ç‡**: åŸæœ¬æ¯50æ­¥è®°å½•è¯¦ç»†æŒ‡æ ‡æ—¶éƒ½ä¼šè¯†åˆ«GPU

### 3. **åˆ†å¸ƒå¼FLOPsåŒæ­¥å¼€é”€**
- **é—®é¢˜**: æ¯æ¬¡FLOPsæµ‹é‡åè¿›è¡Œå¤šæ¬¡å¹¿æ’­æ“ä½œ
- **å½±å“**: åˆ†å¸ƒå¼é€šä¿¡å»¶è¿Ÿç´¯ç§¯
- **é¢‘ç‡**: æ¯æ¬¡æµ‹é‡éƒ½åŒæ­¥åˆ°æ‰€æœ‰è¿›ç¨‹

### 4. **æ•°æ®é›†æŒ‡æ ‡æ›´æ–°å¼€é”€**
- **é—®é¢˜**: æ¯ä¸ªè®­ç»ƒæ­¥éª¤éƒ½è°ƒç”¨`_update_dataset_metrics()`
- **å½±å“**: å¤§é‡tensoræ“ä½œå’Œå­—å…¸æ›´æ–°
- **ç´¯ç§¯æ•ˆåº”**: å¤šæ•°æ®é›†è®­ç»ƒæ—¶å¼€é”€çº¿æ€§å¢é•¿

### 5. **è¿‡åº¦çš„WandBè®°å½•**
- **é—®é¢˜**: æ¯æ­¥è®°å½•å¤§é‡è¯¦ç»†æŒ‡æ ‡
- **å½±å“**: WandB APIè°ƒç”¨å¼€é”€
- **é¢‘ç‡**: æ¯10æ­¥è®°å½•è¯¦ç»†æ€§èƒ½æŒ‡æ ‡

### 6. **ç›‘æ§ç³»ç»Ÿå¼€é”€**
- **é—®é¢˜**: é¢‘ç¹çš„æœ¬åœ°æ—¥å¿—ä¿å­˜å’ŒæŒ‡æ ‡è®¡ç®—
- **å½±å“**: I/Oæ“ä½œå’ŒCPUè®¡ç®—å¼€é”€

### 7. **è¿›åº¦æ¡æ›´æ–°å¼€é”€**
- **é—®é¢˜**: æ¯ä¸ªæœ‰æ•ˆæ­¥éª¤éƒ½æ›´æ–°è¿›åº¦æ¡
- **å½±å“**: tqdmæ›´æ–°æ“ä½œçš„CPUå¼€é”€

## âš¡ æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¤§å¹…å‡å°‘FLOPs Profilingé¢‘ç‡

**ä¿®å¤å‰**:
```python
should_measure_flops = (
    not flops_profiled or  # ç¬¬ä¸€æ¬¡æµ‹é‡
    (effective_step > 0 and effective_step % 50 == 0)  # æ¯50ä¸ªæœ‰æ•ˆæ­¥éª¤é‡æ–°æµ‹é‡
)
```

**ä¿®å¤å**:
```python
should_measure_flops = (
    not flops_profiled or  # ä»…ç¬¬ä¸€æ¬¡æµ‹é‡
    (effective_step > 0 and effective_step % 500 == 0)  # æ¯500ä¸ªæœ‰æ•ˆæ­¥éª¤é‡æ–°æµ‹é‡
)
```

**æ€§èƒ½æå‡**: å‡å°‘90%çš„profilingå¼€é”€ï¼ˆ50æ­¥â†’500æ­¥ï¼‰

### 2. æ–°å¢GPUè¯†åˆ«ç¼“å­˜ä¼˜åŒ–

**ä¿®å¤å‰**:
```python
def get_gpu_peak_flops():
    # æ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°è¯†åˆ«GPU
    gpu_name = torch.cuda.get_device_name(0).upper()
    # æŸ¥æ‰¾åŒ¹é…çš„GPUå¹¶æ‰“å°
    print(f"âœ… è¯†åˆ«GPU: {gpu_name} -> {gpu_model}")
```

**ä¿®å¤å**:
```python
# å…¨å±€ç¼“å­˜GPUå³°å€¼æ€§èƒ½ï¼Œé¿å…é‡å¤è¯†åˆ«
_GPU_PEAK_FLOPS_CACHE = None

def get_gpu_peak_flops():
    global _GPU_PEAK_FLOPS_CACHE
    
    # å¦‚æœå·²ç»ç¼“å­˜ï¼Œç›´æ¥è¿”å›
    if _GPU_PEAK_FLOPS_CACHE is not None:
        return _GPU_PEAK_FLOPS_CACHE
    
    # ä»…é¦–æ¬¡è¯†åˆ«æ—¶æ‰“å°å’Œç¼“å­˜
    print(f"âœ… è¯†åˆ«GPU: {gpu_name} -> {gpu_model}")
    _GPU_PEAK_FLOPS_CACHE = peak_flops
    return _GPU_PEAK_FLOPS_CACHE
```

**æ€§èƒ½æå‡**: å‡å°‘99%çš„GPUè¯†åˆ«å¼€é”€

### 3. ç®€åŒ–åˆ†å¸ƒå¼FLOPsåŒæ­¥

**ä¿®å¤å‰**:
```python
# æ¯æ¬¡æµ‹é‡éƒ½è¿›è¡Œå¹¿æ’­åŒæ­¥
if should_measure_flops and self.dist_ctx.world_size > 1:
    # å¤šæ¬¡å¹¿æ’­æ“ä½œ
    dist.broadcast(flops_tensor, src=0)
    dist.broadcast(seq_tensor, src=0)
```

**ä¿®å¤å**:
```python
# ä»…åœ¨é¦–æ¬¡æˆåŠŸæµ‹é‡æ—¶è¿›è¡Œä¸€æ¬¡åŒæ­¥
if should_measure_flops and real_time_flops is not None and self.dist_ctx.world_size > 1 and not flops_profiled:
    try:
        dist.broadcast(flops_tensor, src=0)
        dist.broadcast(seq_tensor, src=0)
    except Exception as e:
        print(f"âš ï¸  FLOPsåŒæ­¥å¤±è´¥: {e}")
```

**æ€§èƒ½æå‡**: å‡å°‘99%çš„åˆ†å¸ƒå¼åŒæ­¥å¼€é”€

### 4. ä¼˜åŒ–æ•°æ®é›†æŒ‡æ ‡æ›´æ–°

**ä¿®å¤å‰**:
```python
# æ¯ä¸ªè®­ç»ƒæ­¥éª¤éƒ½æ›´æ–°
self._update_dataset_metrics(batch, outputs, aggregated_loss)

# å†…éƒ¨è¿›è¡Œå¤§é‡tensoræ“ä½œ
predictions = torch.argmax(logits, dim=-1)
for i, dataset_name in enumerate(dataset_names):
    label = labels[i].item()
    pred = predictions[i].item()
```

**ä¿®å¤å**:
```python
# æ¯10æ­¥æ›´æ–°ä¸€æ¬¡
if self.enable_dataset_metrics and (self.current_step % 10 == 0):
    self._update_dataset_metrics(batch, outputs, aggregated_loss)

# å»¶è¿Ÿè®¡ç®—ï¼Œæ‰¹é‡å¤„ç†
predictions = None  # å»¶è¿Ÿè®¡ç®—
avg_loss_per_sample = aggregated_loss / dataset_count  # æ‰¹é‡è®¡ç®—
```

**æ€§èƒ½æå‡**: å‡å°‘90%çš„æ•°æ®é›†æŒ‡æ ‡å¼€é”€

### 5. ä¼˜åŒ–WandBè®°å½•é¢‘ç‡

**ä¿®å¤å‰**:
```python
# è¯¦ç»†æŒ‡æ ‡æ¯10æ­¥è®°å½•
should_log_detailed = (step % 10 == 0)

# æ¯æ­¥è®°å½•æ‰€æœ‰æŒ‡æ ‡
wandb_data = {
    "training/loss": float(loss),
    "training/lr": float(learning_rate),
    "training/grad_norm": float(grad_norm),  # æ¯æ­¥è®°å½•
    "training/epoch": float(epoch),
    "global_step": int(step)
}
```

**ä¿®å¤å**:
```python
# è¯¦ç»†æŒ‡æ ‡æ¯50æ­¥è®°å½•
should_log_detailed = (step % 50 == 0)

# åŸºç¡€æŒ‡æ ‡è½»é‡çº§è®°å½•
wandb_data = {
    "training/loss": float(loss),
    "training/lr": float(learning_rate),
    "training/epoch": float(epoch),
    "global_step": int(step)
}

# è¯¦ç»†æŒ‡æ ‡é™é¢‘è®°å½•
if should_log_detailed:
    wandb_data.update({
        "training/grad_norm": float(grad_norm),  # ä»…åœ¨è¯¦ç»†è®°å½•æ—¶
        "perf/step_time": float(step_time),
    })
```

**æ€§èƒ½æå‡**: å‡å°‘80%çš„WandB APIè°ƒç”¨

### 6. ä¼˜åŒ–ç›‘æ§ç³»ç»Ÿ

**ä¿®å¤å‰**:
```python
# æ¯100æ­¥ä¿å­˜æœ¬åœ°æ—¥å¿—
if step % 100 == 0:
    self.save_logs()
```

**ä¿®å¤å**:
```python
# æ¯200æ­¥ä¿å­˜æœ¬åœ°æ—¥å¿—
if step % 200 == 0:
    self.save_logs()
```

**æ€§èƒ½æå‡**: å‡å°‘50%çš„I/Oæ“ä½œ

### 7. ä¼˜åŒ–è¿›åº¦æ¡æ›´æ–°

**ä¿®å¤å‰**:
```python
# æ¯ä¸ªæœ‰æ•ˆæ­¥éª¤éƒ½æ›´æ–°è¿›åº¦æ¡
pbar.update(1)
pbar.set_postfix({...})
```

**ä¿®å¤å**:
```python
# æ¯10ä¸ªæœ‰æ•ˆæ­¥éª¤æ‰¹é‡æ›´æ–°è¿›åº¦æ¡
if effective_step % 10 == 0:
    pbar.update(10)  # ä¸€æ¬¡æ›´æ–°10æ­¥
    pbar.set_postfix({...})
```

**æ€§èƒ½æå‡**: å‡å°‘90%çš„è¿›åº¦æ¡æ›´æ–°å¼€é”€

## ğŸ“Š æ€§èƒ½æå‡é¢„æœŸ

### æ•´ä½“æ€§èƒ½æå‡
- **FLOPs Profiling**: å‡å°‘90%å¼€é”€ï¼Œæå‡20-45%æ€§èƒ½
- **GPUè¯†åˆ«ç¼“å­˜**: å‡å°‘99%å¼€é”€ï¼Œæå‡2-5%æ€§èƒ½
- **åˆ†å¸ƒå¼åŒæ­¥**: å‡å°‘99%å¼€é”€ï¼Œæå‡5-10%æ€§èƒ½
- **æ•°æ®é›†æŒ‡æ ‡**: å‡å°‘90%å¼€é”€ï¼Œæå‡5-15%æ€§èƒ½
- **WandBè®°å½•**: å‡å°‘80%å¼€é”€ï¼Œæå‡3-8%æ€§èƒ½
- **ç›‘æ§ç³»ç»Ÿ**: å‡å°‘50%å¼€é”€ï¼Œæå‡2-5%æ€§èƒ½
- **è¿›åº¦æ¡æ›´æ–°**: å‡å°‘90%å¼€é”€ï¼Œæå‡1-3%æ€§èƒ½

### é¢„æœŸæ€»ä½“æå‡
- **å•æ­¥è®­ç»ƒæ—¶é—´**: å‡å°‘35-70%
- **æ•´ä½“è®­ç»ƒé€Ÿåº¦**: æå‡50-90%
- **å†…å­˜ä½¿ç”¨**: è½»å¾®å‡å°‘ï¼ˆ5-10%ï¼‰
- **ç½‘ç»œé€šä¿¡**: æ˜¾è‘—å‡å°‘ï¼ˆ80-90%ï¼‰
- **CPUä½¿ç”¨**: æ˜¾è‘—å‡å°‘ï¼ˆ30-50%ï¼‰

## ğŸ”§ é…ç½®è°ƒæ•´å»ºè®®

### 1. è¿›ä¸€æ­¥é™ä½ç›‘æ§å¼€é”€
å¦‚æœä»è§‰å¾—æ…¢ï¼Œå¯ä»¥è¿›ä¸€æ­¥è°ƒæ•´ï¼š

```python
# è¿›ä¸€æ­¥é™ä½FLOPsæµ‹é‡é¢‘ç‡
should_measure_flops = (
    not flops_profiled  # ä»…é¦–æ¬¡æµ‹é‡ï¼Œä¸é‡å¤æµ‹é‡
)

# è¿›ä¸€æ­¥é™ä½WandBè®°å½•é¢‘ç‡
should_log_detailed = (step % 100 == 0)  # æ¯100æ­¥

# å®Œå…¨ç¦ç”¨æ•°æ®é›†æŒ‡æ ‡ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
self.enable_dataset_metrics = False
```

### 2. ä½¿ç”¨è½»é‡çº§ç›‘æ§æ¨¡å¼
```python
# åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®
wandb:
  log_dataset_metrics: false  # ç¦ç”¨æ•°æ®é›†æŒ‡æ ‡
  reduced_logging: true       # å¯ç”¨å‡å°‘è®°å½•æ¨¡å¼
```

### 3. é’ˆå¯¹å¤§æ¨¡å‹çš„ä¼˜åŒ–
```python
# å¤§æ¨¡å‹å»ºè®®é…ç½®
training:
  logging_steps: 100          # é™ä½æ—¥å¿—é¢‘ç‡
  eval_steps: 1000           # é™ä½è¯„ä¼°é¢‘ç‡
  save_steps: 2000           # é™ä½ä¿å­˜é¢‘ç‡
```

## âœ… éªŒè¯æ–¹æ³•

### 1. ç›‘æ§è®­ç»ƒé€Ÿåº¦
```bash
# è§‚å¯Ÿæ¯æ­¥è€—æ—¶
# ä¼˜åŒ–å‰ï¼šå¯èƒ½3-5ç§’/æ­¥
# ä¼˜åŒ–åï¼šåº”è¯¥1.5-3ç§’/æ­¥
```

### 2. æ£€æŸ¥GPUåˆ©ç”¨ç‡
```bash
# ä½¿ç”¨nvidia-smiè§‚å¯Ÿ
# GPUåˆ©ç”¨ç‡åº”è¯¥æ›´åŠ ç¨³å®šï¼Œæ¥è¿‘90-95%
```

### 3. è§‚å¯ŸWandBå›¾è¡¨
- è®­ç»ƒlossæ›²çº¿åº”è¯¥æ›´åŠ å¹³æ»‘
- step_timeæŒ‡æ ‡åº”è¯¥æ˜æ˜¾é™ä½
- MFUæŒ‡æ ‡åº”è¯¥æœ‰æ‰€æå‡

### 4. éªŒè¯GPUè¯†åˆ«
- GPUè¯†åˆ«ä¿¡æ¯åº”è¯¥åªåœ¨è®­ç»ƒå¼€å§‹æ—¶å‡ºç°ä¸€æ¬¡
- ä¸åº”è¯¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­é‡å¤å‡ºç°"âœ… è¯†åˆ«GPU"æ¶ˆæ¯

## ğŸ¯ æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§çš„æ€§èƒ½ä¼˜åŒ–ï¼Œä¸»è¦è§£å†³äº†ï¼š

1. **FLOPs Profilingè¿‡åº¦å¼€é”€**ï¼šä»æ¯50æ­¥å‡å°‘åˆ°æ¯500æ­¥
2. **GPUè¯†åˆ«é‡å¤å¼€é”€**ï¼šé€šè¿‡å…¨å±€ç¼“å­˜æœºåˆ¶ï¼Œä»…é¦–æ¬¡è¯†åˆ«
3. **åˆ†å¸ƒå¼åŒæ­¥å†—ä½™**ï¼šä»æ¯æ¬¡æµ‹é‡å‡å°‘åˆ°ä»…é¦–æ¬¡åŒæ­¥
4. **æ•°æ®é›†æŒ‡æ ‡é¢‘ç¹æ›´æ–°**ï¼šä»æ¯æ­¥å‡å°‘åˆ°æ¯10æ­¥
5. **WandBè¿‡åº¦è®°å½•**ï¼šä»æ¯10æ­¥è¯¦ç»†è®°å½•å‡å°‘åˆ°æ¯50æ­¥
6. **ç›‘æ§ç³»ç»Ÿä¼˜åŒ–**ï¼šå‡å°‘I/Oæ“ä½œé¢‘ç‡
7. **è¿›åº¦æ¡æ›´æ–°ä¼˜åŒ–**ï¼šä»æ¯æ­¥æ›´æ–°å‡å°‘åˆ°æ¯10æ­¥æ‰¹é‡æ›´æ–°

è¿™äº›ä¼˜åŒ–åœ¨ä¿æŒåŠŸèƒ½å®Œæ•´æ€§çš„åŒæ—¶ï¼Œæ˜¾è‘—æå‡äº†è®­ç»ƒæ€§èƒ½ï¼Œé¢„æœŸèƒ½å°†è®­ç»ƒé€Ÿåº¦æå‡50-90%ã€‚ç°åœ¨GPUè¯†åˆ«æ¶ˆæ¯åº”è¯¥åªåœ¨è®­ç»ƒå¼€å§‹æ—¶å‡ºç°ä¸€æ¬¡ï¼Œä¸ä¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­é‡å¤å‡ºç°ã€‚ 